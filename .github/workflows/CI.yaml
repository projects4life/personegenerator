name: CI

on:
  push:
    branches: [ "googletest" ]

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout

jobs:
  CI:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
    - uses: actions/checkout@v3
      id: git_clone

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      id: aws_configure
      with:
        role-to-assume: arn:aws:iam::405854541726:role/github-actions-role
        role-session-name: samplerolesession
        aws-region: us-east-2

    - name: Google Auth
      id: auth
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

    - name: Docker Auth
      run: gcloud auth configure-docker europe-docker.pkg.dev

    - name: push the image
      id: new-image-published
      run: |
        docker build -t europe-docker.pkg.dev/personagenerator-379008/personagenerator:1 .
        docker push europe-docker.pkg.dev/personagenerator-379008/personagenerator:1
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS}}


    - name: Slack Notification
      uses: act10ns/slack@v2.0.0
      # send message even if the ci fails
      if: always()
      with:
        status: ${{ job.status }}
        steps: ${{ toJson(steps) }}


        





